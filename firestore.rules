rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isSignedIn() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'ADMIN';
    }
    
    function isTutor() {
      return isSignedIn() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['ADMIN', 'TUTOR'];
    }
    
    function isGuardian() {
      return isSignedIn() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'GUARDIAN';
    }
    
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    // Check if user is guardian of the specified student
    function isGuardianOf(studentId) {
      return isSignedIn() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('linkedStudentIds', []).hasAny([studentId]);
    }
    
    // Check if tutor is assigned to student
    function isTutorOf(studentId) {
      return isTutor() && (
        isAdmin() ||
        get(/databases/$(database)/documents/users/$(studentId)).data.get('tutorId', '') == request.auth.uid
      );
    }
    
    // Users collection
    match /users/{userId} {
      allow read: if isSignedIn();
      allow create: if isOwner(userId) || isAdmin();
      allow update: if isOwner(userId) || isAdmin() || isTutor();
      allow delete: if isAdmin();
    }
    
    // Schools collection
    match /schools/{schoolId} {
      allow read: if isSignedIn();
      allow create, update: if isTutor();
      allow delete: if isAdmin();
    }
    
    // Lessons collection
    match /lessons/{lessonId} {
      allow read: if isSignedIn();
      allow create, update: if isTutor();
      allow delete: if isAdmin();
    }
    
    // Questions collection
    match /questions/{questionId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isTutor() || isOwner(resource.data.studentId);
      allow delete: if isAdmin();
    }
    
    // ===== NEW COLLECTIONS =====
    
    // Attendance (勤怠)
    match /attendance/{attendanceId} {
      allow read: if isSignedIn() && (
        isAdmin() ||
        resource.data.tutorId == request.auth.uid ||
        resource.data.studentId == request.auth.uid ||
        isGuardianOf(resource.data.studentId)
      );
      allow create: if isTutor();
      allow update: if isTutor() || isAdmin();
      allow delete: if isAdmin();
    }
    
    // Invoices (請求)
    match /invoices/{invoiceId} {
      allow read: if isSignedIn() && (
        isAdmin() ||
        resource.data.tutorId == request.auth.uid ||
        resource.data.guardianId == request.auth.uid ||
        isGuardianOf(resource.data.studentId)
      );
      allow create: if isTutor() || isAdmin();
      allow update: if isTutor() || isAdmin();
      allow delete: if isAdmin();
    }
    
    // Messages
    match /messages/{messageId} {
      allow read: if isSignedIn() && (
        resource.data.fromUserId == request.auth.uid ||
        resource.data.toUserId == request.auth.uid ||
        isAdmin()
      );
      allow create: if isSignedIn();
      allow update: if resource.data.toUserId == request.auth.uid || isAdmin();
      allow delete: if isAdmin();
    }
    
    // Study Logs (学習ログ)
    match /study_logs/{logId} {
      allow read: if isSignedIn() && (
        resource.data.studentId == request.auth.uid ||
        isTutor() ||
        isGuardianOf(resource.data.studentId)
      );
      allow create: if isSignedIn() && request.resource.data.studentId == request.auth.uid;
      allow update: if isOwner(resource.data.studentId) || isTutor();
      allow delete: if isAdmin();
    }
    
    // Goals (目標)
    match /goals/{goalId} {
      allow read: if isSignedIn() && (
        resource.data.studentId == request.auth.uid ||
        isTutor() ||
        isGuardianOf(resource.data.studentId)
      );
      allow create: if isSignedIn();
      allow update: if isOwner(resource.data.studentId) || isTutor();
      allow delete: if isOwner(resource.data.studentId) || isAdmin();
    }
    
    // Analytics Events
    match /analytics_events/{eventId} {
      allow create: if isSignedIn();
      allow read: if isAdmin();
      allow update, delete: if false; // Immutable
    }
    
    // Audit logs
    match /audit_logs/{logId} {
      allow create: if isSignedIn();
      allow read: if isAdmin();
      allow update, delete: if false; // Immutable
    }
    
    // Rate limits - Cloud Functions only
    match /rate_limits/{limitId} {
      allow read, write: if false;
    }
    
    // API usage logs
    match /api_usage_logs/{logId} {
      allow read: if isAdmin();
      allow write: if false;
    }
    
    // System config
    match /system_config/{configId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }
    
    // Exam scores
    match /exam_scores/{scoreId} {
      allow read: if isSignedIn();
      allow create, update: if isTutor();
      allow delete: if isAdmin();
    }
  }
}
